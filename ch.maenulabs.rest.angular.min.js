/**
 * ch.maenulabs.rest.angular v0.4.0
 * built on 29.08.2015
 * Copyright 2015 Manuel Leuenberger
 * licenced under MIT, see LICENSE.txt
 */
angular.module("ch.maenulabs.rest.angular.controller",[]),angular.module("ch.maenulabs.rest.angular",["ch.maenulabs.rest.angular.resource","ch.maenulabs.rest.angular.controller"]),angular.module("ch.maenulabs.rest.angular.resource",[]),angular.module("ch.maenulabs.rest.angular.controller").factory("ch.maenulabs.rest.angular.controller.CreateFactory",function(){return["$scope","resource",function(a,b){a.resource=b,a.$watch("resource.hasErrors()",function(b){b?a.$emit("ch.maenulabs.rest.angular.controller.validation.Error",a.resource):a.$emit("ch.maenulabs.rest.angular.controller.validation.Success",a.resource)}),a.create=function(){a.resource.create().then(function(b){a.$emit("ch.maenulabs.rest.angular.controller.create.Success",a.resource,b)})["catch"](function(b){a.$emit("ch.maenulabs.rest.angular.controller.create.Error",a.resource,b)})}}]}),angular.module("ch.maenulabs.rest.angular.controller").factory("ch.maenulabs.rest.angular.controller.ReadFactory",function(){return["$scope","resource",function(a,b){a.resource=b}]}),angular.module("ch.maenulabs.rest.angular.controller").factory("ch.maenulabs.rest.angular.controller.SearchFactory",["$timeout","$q",function(a,b){var c=ch.maenulabs.type.Type(Object,{delay:null,state:null,promise:null,initialize:function(a){this.delay=a,this.state=this.type.INITIALIZED,this.promise=b.defer().promise},schedule:function(c){this.state=this.type.SCHEDULED;var d=b.defer();return this.promise=a(angular.bind(this,function(){return c().then(angular.bind(this,function(a){return this.state=this.type.SUCCESS,d.resolve(a),a}))["catch"](angular.bind(this,function(a){return this.state=this.type.ERROR,d.reject(a),a}))}),this.delay),this.promise["catch"](angular.bind(this,function(a){return this.state=this.type.CANCELLED,d.reject(a),a})),d.promise},cancel:function(){a.cancel(this.promise)}},{INITIALIZED:1,SCHEDULED:2,CANCELLED:3,SUCCESS:4,ERROR:5}),d=1e3;return["$scope","resource",function(a,b){a.resource=b,a.currentSearchEvent=new c(d),a.search=function(){a.currentSearchEvent.cancel(),a.currentSearchEvent=new c(d),a.currentSearchEvent.schedule(a.resource.search).then(function(b){return a.$emit("ch.maenulabs.rest.angular.controller.search.Success",a.currentSearchEvent,a.resource,b),b})["catch"](function(b){return a.$emit("ch.maenulabs.rest.angular.controller.search.Error",a.currentSearchEvent,a.resource,b),b}),a.$emit("ch.maenulabs.rest.angular.controller.search.Pending",a.currentSearchEvent,a.resource)},a.$watchGroup(a.resource.getChangeables(),a.search)}]}]),angular.module("ch.maenulabs.rest.angular.controller").factory("ch.maenulabs.rest.angular.controller.UpdateFactory",function(){return["$scope","resource",function(a,b){a.resource=b,a.$watchGroup(a.resource.getChangeables(),function(){a.$emit("ch.maenulabs.rest.angular.controller.Change",a.resource)}),a.$watch("resource.hasErrors()",function(b){b?a.$emit("ch.maenulabs.rest.angular.controller.validation.Error",a.resource):a.$emit("ch.maenulabs.rest.angular.controller.validation.Success",a.resource)}),a.update=function(){a.resource.update().then(function(b){a.$emit("ch.maenulabs.rest.angular.controller.update.Success",a.resource,b)})["catch"](function(b){a.$emit("ch.maenulabs.rest.angular.controller.update.Error",a.resource,b)})}}]}),angular.module("ch.maenulabs.rest.angular.resource").factory("ch.maenulabs.rest.angular.resource.AbstractResource",["$http",function(a){var b=function(a){var c={};for(var d in a)if(a.hasOwnProperty(d)){var e=a[d];if(e instanceof Object){e=b(e);for(var f in e)e.hasOwnProperty(f)&&(c[d+"."+f]=e[f])}else c[d]=e}return c},c=ch.maenulabs.validation.Validation;return new ch.maenulabs.type.Type(Object,{initialize:function(a){angular.extend(this,a||{}),this.validation=this.validation||new c},hasErrors:function(){return this.validation.hasErrors(this)},getErrors:function(){return this.validation.getErrors(this)},hasError:function(a){var b=this.validation.getErrors(this);return b[a]&&b[a].length>0},getError:function(a){return this.validation.getErrors(this)[a]||[]},getChangeables:function(){throw new Error("not implemented")},create:function(){return a({url:this.getBaseUri(),method:"POST",data:this.serialize()}).then(angular.bind(this,function(a){return this.uri=a.headers("location"),a}))},read:function(){return a({url:this.uri,method:"GET"}).then(angular.bind(this,function(a){return this.deserialize(a.data),a}))},update:function(){return a({url:this.uri,method:"PUT",data:this.serialize()})},remove:function(){a({url:this.uri,method:"DELETE"}).then(angular.bind(this,function(a){return this.uri=null,a}))},search:function(){var b=a({url:this.getSearchUri(),method:"GET"});return b.then(angular.bind(this,function(a){var b=angular.fromJson(a.data);a.results=[];for(var c=0;c<b.length;c+=1)a.results.push(this.type.desimplify(b[c]));return a}))},serialize:function(){return angular.toJson(this.simplify())},deserialize:function(a){this.desimplify(angular.fromJson(a))},simplify:function(){return{uri:this.uri}},desimplify:function(a){this.uri=a.uri},getBaseUri:function(){throw new Error("not implemented")},getSearchUri:function(){return this.getBaseUri()+"?"+this.toSearchParameters()},toSearchParameters:function(){var a=[],c=b(this.simplify());for(var d in c){var e=c[d];if(null!=e){var f=encodeURIComponent(d)+"="+encodeURIComponent(e);a.push(f)}}return a.join("&")}},{deserialize:function(a){var b=new this;return b.deserialize(a),b},desimplify:function(a){var b=new this;return b.desimplify(a),b}})}]);